import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import rateLimit from 'express-rate-limit';
import { env } from './config/env';
import { authenticate } from './middleware/auth.middleware';
import { tenantContext } from './middleware/tenant.middleware';
import { errorHandler } from './middleware/error.middleware';

import authRoutes from './routes/auth.routes';
import toolsRoutes from './routes/tools.routes';
import categoriesRoutes from './routes/categories.routes';
import customersRoutes from './routes/customers.routes';
import rentalsRoutes from './routes/rentals.routes';
import paymentsRoutes from './routes/payments.routes';
import maintenanceRoutes from './routes/maintenance.routes';
import searchRoutes from './routes/search.routes';
import tenantRoutes from './routes/tenant.routes';
import activityRoutes from './routes/activity.routes';
import * as webhooksCtrl from './controllers/webhooks.controller';
import templatesRoutes from './routes/templates.routes';
import financeRoutes from './routes/finance.routes';
import communicationsRoutes from './routes/communications.routes';
import quotesRoutes from './routes/quotes.routes';
import intelligenceRoutes from './routes/intelligence.routes';
import stripeRoutes from './routes/stripe.routes';

import { globalLimiter } from './middleware/rate-limit.middleware';
import hpp from 'hpp';

const app = express();

// Global Rate limiting
// app.use(globalLimiter); // Disabled temporarily for deployment debugging

// Security
app.set('trust proxy', 1);
app.use(helmet({
    contentSecurityPolicy: false,
}));
app.use(hpp());
app.use(cors()); // Temporarily wide open for health checks

// Stripe Webhooks & Routes (Handles raw body internally)
app.use('/api/subscriptions', stripeRoutes);

// General Parsing
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
if (env.NODE_ENV !== 'test') {
    app.use(morgan('dev'));
}

// Health check (Must be before general parity)
app.get('/health', (req, res) => {
    res.status(200).json({ status: 'ok', timestamp: new Date().toISOString() });
});

// Webhooks (Public)
app.post('/api/webhooks/asaas', express.json(), webhooksCtrl.asaasWebhook);

// Public routes
app.use('/api/auth', authRoutes);

// Protected routes - all require authentication + tenant context
app.use('/api', authenticate, tenantContext);
app.use('/api/tools', toolsRoutes);
app.use('/api/tool-categories', categoriesRoutes);
app.use('/api/customers', customersRoutes);
app.use('/api/rentals', rentalsRoutes);
app.use('/api/payments', paymentsRoutes);
app.use('/api/maintenance', maintenanceRoutes);
app.use('/api/search', searchRoutes);
app.use('/api/tenant', tenantRoutes);
app.use('/api/activity', activityRoutes);
app.use('/api/contract-templates', templatesRoutes);
app.use('/api/finance', financeRoutes);
app.use('/api/communications', communicationsRoutes);
app.use('/api/quotes', quotesRoutes);
app.use('/api/intelligence', intelligenceRoutes);

// Centralized error handler


app.use(errorHandler);

export default app;
